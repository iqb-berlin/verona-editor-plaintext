<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IQB-Editor f√ºr Text</title>

    <meta name="application-name" content="verona-editor-plaintext"
          data-version="1.2.0"
		  data-module-type="verona-editor"
          data-repository-url="https://github.com/iqb-berlin/verona-editor-plaintext"
          data-api-version="2.0.0"
          data-not-supported-api-features=""
          data-supported-unit-definition-types=""
    />

    <template id="editor-info-template">
        <div style="display: flex;">
            <div style="flex: 50%; padding: 2px">
                <h1>Verona Editor Plain Text</h1>
                <p>
                    This is a simple, dependency-less, vanilla-js-written, but full-featured unit editor,
                    mainly as showcase for developers, for editing script based unit definitions and to fix
					problems with unit definitions by editing the definition as plain text.
                </p>
                <p>
                    It is to be used as iframe content and implements the
                    <a href="https://github.com/verona-interfaces/editor" target="_blank">Verona Interface Specification for Editors</a>, so all 
					applications which implement this interface can act as host.
                </p>
            </div>
            <div style="flex: 50%; padding: 2px">
                <h3>Editor Specs</h3>
                <table id="editor-meta" style="width:100%"><!-- will be filled automatically --></table>
            </div>
        </div>
    </template>

    <style>
        body {
            height: 100vh; overflow: hidden; font-family: sans-serif; margin: 0; padding: 10px; display: flex;
        }

        #editor-div {
            flex: 1;
			display: flex;
			flex-direction: column;
        }
		#editor {
			resize: none;
			height: calc(100% - 30px);
		}

        #help-img {
            padding: 5px;
        }
    </style>
</head>
<body>
<div id="editor-div"><textarea id="editor"></textarea></div>
<div id="help-img-div"><a target="_blank" href="https://github.com/iqb-berlin/iqb-berlin.github.io/wiki"><img id="help-img" alt="Fragezeichen" title="Hilfe/Feedback" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAJ/SURBVHjapJM9aFRbEMd/K6LPr2QVRRA/VnjIgi+6Wq0fxU0Q3EIwEOMTRV+0WhQ0WEkQXBtFbVwbYyEuaJEoUaMgW5jlahXU4soqrr6AqwhamHiugtwzZ8lY3KDR8JrndHOY/+8M/5lJqCq/E9N/fSjeHM0653LiGp6ItFgRRKRqrfjOSflSz8bhyfWJyR0Ub43lnbjOhQsSba3r5jN/VgJVxUTKQOU1T5+9r0SRvdF/dmvvFMCFW2N5cY2O/dsWbXn2bwK/BkE9LsqkwEuHLF/RxNHC3fvW2oF7FztjiKpSvDmaPdf/YWj067iWfFXvmGqprGoiVVXVulHt7lUtlY2+/jSurQeuDW3cczmrqkwDcK6RW71qRlv1VYJSOf7xn63gB7C/CEENCl1Q8uHpy8/s27m+TazLAROARsPLrGzCrwER1A0UB6HQB34txB8OaZ4JyT/gtl9n06plWBHvB8C5ljnTlaAGBqjXoVQGE4GXhkK+mQcvQ4IgwA8MTU0gYlu+j1HEoRoLiMAQQgSZNFw50szgg5Du3gCDIRkbh3OOHx2IVEM7TiYVYqIQjIHI4KXiKXSdr8dwIJNKYsLPiLjqd4AV8V+8+4KXASKDwWAig18znOx/A8RAImj3UjwfCRHn/MkelK/feVFZ/ec8uttjCBi8NJz4e8VEDt27UmxYP5eDhb5Kw7nyT4u09/hQ3lrpONOT2/Lw0VtuDxuCWizMpJO0Z5Ns+msem3ecvy/ODYw9Od07ZZW3Hx7MR9Z27u5Y07Z26WyWLF4QmxuGPB8JOXSyr+LE3fg4IZ4CAGjtupq1YnORFU9sfExWpOqc+CKN8ujjU/99TP8nvg0AOD6BJZa9bgUAAAAASUVORK5CYII="></a></div>

<script>
    // some settings, that might be overridden for testing per query-params in URL
    const editorSettings = Object.assign(
        {
            debounceStateMessages: 1000,
            debounceKeyboardEvents: 100
        },
        location.search
            .substr(1)
            .split("&")
            .reduce((carry, item) => {const tmp = item.split("="); carry[tmp[0]] = tmp[1]; return carry;}, {})
    );

    // verona supported settings
    let editorConfig = {
        definitionReportPolicy: 'eager', // "on-demand"
    }

    let sessionId = "";

    const isDefined = v => (typeof v !== "undefined");

    const Time = new class {
        throttle = (callback, limit) => {
            let waiting = false;
            return function() {
                if (waiting) return;
                callback.apply(this, arguments);
                waiting = true;
                setTimeout(() => {
                    waiting = false;
                }, limit);
            }
        }

        debounce = (callback, limit, debounceCallback) => {
            let handle = null;
            return function() {
                if (typeof debounceCallback === "function") {
                    debounceCallback.apply(this, arguments);
                }
                clearTimeout(handle);
                handle = setTimeout(() => {
                    callback.apply(this, arguments);
                }, limit);
            }
        }
    }

    const Message = new class {
        send = new class {
            _lastStates = {
                unitDefinition: null,
                player: null
            };

            voeDefinitionChangedNotification = () => {
                if (editorConfig.definitionReportPolicy === "eager") {
                    this._sendVoeDefinitionChangedNotification();
                }
            };

            _sendVoeDefinitionChangedNotification = Time.debounce(
                () => {
                    const message = this._createStateMsg();
                    if (message.unitDefinition) {
                        this._send(message);
                    }
                },
                parseInt(editorSettings.debounceStateMessages, 10),
                () => {
                    document.dispatchEvent(new CustomEvent('queued:voeDefinitionChangedNotification', {}))
                }
            );

            voeGetDefinitionResponse = () => this._send(this._createStateMsg());

            voeReadyNotification = () => {
				document.querySelector('#editor').focus();
                this._send(Object.assign(
                    {type: 'voeReadyNotification'},
                    document.querySelector('meta[name="application-name"]').dataset
                ));
            };

            _send = msg => {
                window.parent.postMessage(msg, '*');
                document.dispatchEvent(new CustomEvent('sent:' + msg.type, {detail: msg}));
            }

            _createStateMsg = () => {
                const message = {
                    type: 'voeDefinitionChangedNotification',
                    sessionId: sessionId,
                    timeStamp: Date.now(),
                    unitDefinition: document.querySelector('#editor').value,
                }
                return message;
            }
        }

        receive = (type, data) => {
            if (type === "voeStartCommand") {
				sessionId = data.sessionId;
                document.querySelector('#editor').value = data.unitDefinition;
            } else {
				if (sessionId && (data.sessionId !== sessionId)) {
					throw new Error("Wrong sessionId");
				}
				document.dispatchEvent(new CustomEvent(type, {detail: data}));
			}
        };
    }

    const getEditorInfoHTML = () => {
		const infoBoxElem = document.createElement('div');
		infoBoxElem.innerHTML = document.querySelector('#editor-info-template').innerHTML;
		const meta = {...document.querySelector('meta[name="application-name"]').dataset};
		const tableElement = infoBoxElem.querySelector('table');
		Object.keys(meta).forEach(key => {
			tableElement.innerHTML += `<tr><td>${key}</td><td>${meta[key]}</td></tr>`;
		});
		return infoBoxElem;
	}

	const editorElement = document.querySelector('#editor');
    window.addEventListener('message', event => {Message.receive(event.data.type, event.data)}, false);
    document.addEventListener("DOMContentLoaded", Message.send.voeReadyNotification);
    document.addEventListener("voeGetDefinitionRequest", event => {
        Message.send.voeGetDefinitionResponse();
    });
    editorElement.addEventListener('change', Message.send.voeDefinitionChangedNotification);
    editorElement.addEventListener('keyup', 
        Time.debounce(Message.send.voeDefinitionChangedNotification, parseInt(editorSettings.debounceKeyboardEvents), 10)
    );
	// document.querySelector('#help-img').addEventListener('click', () => {
	// 	console.log(getEditorInfoHTML())}
	// );
</script>

</body>
</html>
